def analyze_with_gemini(transcript_text, audience_desc):
    """Gemini Analysis - Updated with Safety Settings Fix"""
    genai.configure(api_key=GEMINI_API_KEY)
    
    # 1. הגדרות מודל (טמפרטורה נמוכה לדיוק)
    generation_config = genai.types.GenerationConfig(
        temperature=0.15 
    )
    
    # 2. הגדרות בטיחות - קריטי למניעת השגיאה!
    # אנו מבקשים מהמודל לא לחסום שום דבר (BLOCK_NONE) כדי שלא יצנזר את הניתוח
    safety_settings = [
        {
            "category": "HARM_CATEGORY_HARASSMENT",
            "threshold": "BLOCK_NONE"
        },
        {
            "category": "HARM_CATEGORY_HATE_SPEECH",
            "threshold": "BLOCK_NONE"
        },
        {
            "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT",
            "threshold": "BLOCK_NONE"
        },
        {
            "category": "HARM_CATEGORY_DANGEROUS_CONTENT",
            "threshold": "BLOCK_NONE"
        },
    ]
    
    model = genai.GenerativeModel(
        model_name='gemini-1.5-flash',
        generation_config=generation_config,
        safety_settings=safety_settings # הוספנו את זה כאן
    )
    
    prompt = f"""
    תפקיד: אתה יועץ עסקי בכיר המתמחה בפסיכולוגית מכירות ושיווק, ובנוסף עורך לשוני מומחה בעברית.
    
    הקשר: התקבל תמלול גולמי של שיחת מכירה. עליך להתעלם משגיאות תמלול ("רעשים") ולהבין את ההקשר הלוגי.
    המשימה: נתח את השיחה אך ורק על פי המתודולוגיה של מודל "גשר הבהירות" המפורט להלן.
    
    הלקוח בשיחה מוגדר: "{audience_desc}"

    --- הגדרות המודל לניתוח (חובה לפעול לפיהן) ---
    שלב 1 - היווצרות הפער/הצורך: הלקוח פסיבי, חווה סימפטום אך לא מבין את הבעיה.
    שלב 2 - אבחון וחיפוש משמעות: הלקוח מנסה להבין "למה זה קורה לי?".
    שלב 3 - חיפוש פתרונות: הלקוח מנסה להבין "מה האופציות הקיימות לסגירת הפער?".
    שלב 4 - בחינת החלופות (Evaluation): הלקוח מעריך מה הפתרון המתאים ביותר עבורו.
    שלב 5 - קבלת החלטה.

    --- מבנה הדו"ח הנדרש (השתמש בטבלאות Markdown) ---

    ### 📍 שלב הלקוח במסע
    זהה באיזה שלב (1-5) נמצא הלקוח *במהלך השיחה הזו* ונמק בקצרה מדוע.

    ### חלק א': תרגום הסימפטום (The Translation Gap)
    זהה תלונות שהלקוח העלה. האם המוכר תרגם אותן לבעיית שורש?
    * אם המוכר הצליח: תן פידבק חיובי.
    * אם המוכר נכשל: תן פידבק לשיפור + הצעה פרקטית לפעם הבאה (מה היה עליו לומר/לשאול).

    | הסימפטום שהוזכר | הבעיה השורשית (כפי שהוצגה או משתמעת) | פידבק למוכר והצעה ליישום |
    |---|---|---|
    | ... | ... | ... |

    ### חלק ב': משולש האמון (The Trust Triad)
    | סוג האמון | סטטוס (✅/⚠️/❌) | הסבר מנומק |
    |---|---|---|
    | **במוצר/בשיטה** | ... | ... |
    | **במוכר/בסמכות** | ... | ... |
    | **בעצמו (מסוגלות הלקוח)** | ... | ... |

    ### חלק ג': פחדים וחששות
    * **הפחד/החשש המרכזי של הלקוח:** (במשפט אחד)
    * **האם נוטרל בשיחה?** (כן/לא + הסבר קצר)

    ### חלק ד': החסם הקריטי
    מהי הסיבה האחת (האתגר המרכזי) שבגללה העסקה הזו תיתקע או תיפול?

    ### 📝 סיכום ביצועי המוכר
    * **נקודה לשימור (לטובה):** (ציין דבר אחד שהמוכר עשה מצוין).
    * **נקודה לשיפור:** (ציין דבר אחד שדורש שיפור דחוף).

    ---
    התמלול הגולמי לניתוח:
    {transcript_text}
    """
    
    try:
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"שגיאה בניתוח: {str(e)}"
